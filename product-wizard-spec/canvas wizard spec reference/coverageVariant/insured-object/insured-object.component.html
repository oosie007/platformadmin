<div class="insured-object__container">
  <form [formGroup]="insuredObjectForm">
    <div class="insured-object__insured-container">
      <div formGroupName="typeSelectionForm">
        <div class="insured-object__main-insured-wrapper">
          <div class="insured-object__main-insured-select-choice" cbSelectChoice label="Policy holder type"
            styleVariant="default">
            <select [required]="true" formControlName="policyHolderType" placeholder="Define policy holder type"
              (change)="setPartyType()">
              <option *ngFor="let type of policyHolderTypeOptions | inputUnselect" [ngValue]="type.description">
                {{ type.description }}
              </option>
            </select>
          </div>
          <div class="insured-object__error-message-container" *ngIf="policyHolderType.errors && (policyHolderType?.['dirty'] || policyHolderType?.['touched'])">
            <div *ngIf="policyHolderType.errors['required']">
              <div class="error-text-container">
                <cb-icon iconKey="utility-error-stroke" iconColor="error-shade" [iconSize]="cbIconSize.REGULAR" [addPointerClass]="false"></cb-icon>
                <span class="error-text-container__error-text">Select policy holder type </span>
              </div>
            </div>
          </div>
          <div class="insured-object__main-insured-select" [cbSelectMultiple]="selectMultipleInsured" [errorMessage]="
              objectType.invalid && (objectType.dirty || objectType.touched)
                ? 'Required field'
                : null
            ">
            <label class="insured-object__main-insured-label">Object Type</label>
            <p-multiSelect #selectMultipleInsured [selectAll]="selectAllInsured" [options]="insuredList"
              optionLabel="description" [(ngModel)]="selectedObjectTypes" placeholder="Define Insured Object Type"
              inputId="#selectMultipleInsured" formControlName="objectType" (onChange)="
                onMultiSelectChange($event, insuredFormTypes.OBJECTTYPE)
              " (onSelectAllChange)="
                onMultiSelectSelectAllChange(
                  $event,
                  insuredFormTypes.OBJECTTYPE
                )
              " [readonly]="disableEdit"></p-multiSelect>
          </div>
          <div class="insured-object__main-insured-chips-container" *ngIf="objectType?.value?.length > 0">
            <p-chips fieldVariant="stroke" class="insured-object__main-insured-chips" field="description"
              formControlName="objectTypeChipControl" [disabled]="disableEdit"
              (onRemove)="onChipRemove($event, insuredFormTypes.OBJECTTYPE)"></p-chips>
            <button cbButton label="Clear all selection" [disabled]="disableEdit || disableClrSelection" variant="primary"
              (click)="clearSelection(insuredFormTypes.OBJECTTYPE)"></button>
          </div>
        </div>
      </div>
    </div>

    <div class="insured-object__accordions-wrapper" *ngIf="objectFormArray && objectFormArray.length > 0">
      <p-accordion [multiple]="true" [activeIndex]="[0]">
        <ng-container formArrayName="objectsForm" *ngFor="let group of objectFormArray.controls; let i = index">
          <p-accordionTab [formGroupName]="i">
            <ng-template pTemplate="header">
              <input type="hidden" formControlName="objectId" [ngModel]="selectedObjectTypes[i].description"
                [disabled]="disableEdit" />
              <div class="insured-object__accordions-title">
                {{ selectedObjectTypes[i].description }}
              </div>
            </ng-template>
            <ng-template pTemplate="body">
              <div class="insured-object__accordions-form">
                <div class="insured-object__toggle-layout">
                  <div class="insured-object__type__toggle">
                    <div cbToggle color="default" toggleOnText="Set as group" toggleOffText="Set as group" [showIcons]="true">
                      <input type="checkbox" formControlName="isGroup" />
                    </div>
                    <div class="insured-object__toggle-text">Marking this indicator sets this item as a group, enabling
                      group rating for the associated insured objects.</div>
                  </div>
                </div>
                <div class="insured-object__accordions-form-row">
                  <div cbInput label="Minimum count" styleVariant="default" helpText="" [errorMessage]="
                      _validateMinCount(selectedObjectTypes[i].description, i)
                    ">
                    <input placeholder="Minimum count" type="number" pattern=".*" 
                      formControlName="minQuantity" [readOnly]="disableEdit" [disabled]="disableEdit" min="0"/>
                  </div>

                  <div cbInput label="Maximum count" styleVariant="default" helpText="" [errorMessage]="
                      _validateMaxCount(selectedObjectTypes[i].description, i)
                    ">
                    <input placeholder="Maximum count" type="number" pattern=".*" [required]="true"
                      formControlName="maxQuantity" [readOnly]="disableEdit" [disabled]="disableEdit" />
                  </div>
                </div>
                <div class="insured-object__main-insured-wrapper">
                  <div class="insured-object__main-insured-select" [errorMessage]="_validatePredefinedAttribute(objectFormArray.controls[i].get('predefinedAttribute'))" [cbSelectMultiple]="selectPredefinedAttribute">
                    <div class="insured-object__tooltip">
                      <label class="insured-object__main-insured-label">Predefined attributes</label>
                      <div class="insured-object__tooltiptextpa">
                        <cb-tooltip
                          explanationText="Unique characteristics of the insured which can impact product eligibility & pricing. These are typically pre-defined in the master reference data."
                          styleVariant="stroke" [colorTheme]="cbToolTipColorTheme" direction="above-right">
                          <cb-icon iconKey="utility-tooltip-stroke"></cb-icon>
                        </cb-tooltip>
                      </div>
                    </div>
                    <p-multiSelect #selectPredefinedAttribute optionDisabled="inactive" [selectAll]="
                        selectAllFlags[getObjectId(i)]
                          ?.selectAllPredefinedAttributes
                      " [options]="selectedObjectTypes[i].predefinedAttr" optionLabel="description"
                      placeholder="Define predefined attributes" inputId="#selectPredefinedAttribute"
                      formControlName="predefinedAttribute" (onChange)="
                        onMultiSelectChange(
                          $event,
                          insuredFormTypes.PREDEFINEDATTRIBUTE,
                          objectFormArray.controls[i]
                        )
                      " (onSelectAllChange)="
                        onMultiSelectSelectAllChange(
                          $event,
                          insuredFormTypes.PREDEFINEDATTRIBUTE,
                          objectFormArray.controls[i]
                        )
                      " [readOnly]="disableEdit"></p-multiSelect>
                  </div>
                  <div class="insured-object__main-insured-chips-container" *ngIf="
                      objectFormArray.controls[i].get('predefinedAttribute')
                        ?.value?.length > 0
                    ">
                    <p-chips fieldVariant="stroke" class="insured-object__main-insured-chips" field="description"
                      formControlName="predefinedTypeChipControl" [readOnly]="disableEdit" (onRemove)="
                        onChipRemove(
                          $event,
                          insuredFormTypes.PREDEFINEDATTRIBUTE,
                          objectFormArray.controls[i]
                        )
                      "></p-chips>
                    <button cbButton label="Clear all selection" variant="primary" (click)="
                        clearSelection(
                          insuredFormTypes.PREDEFINEDATTRIBUTE,
                          objectFormArray.controls[i]
                        )
                      " [disabled]="disableEdit || ((insuredObjectsList && insuredObjectsList[i] && !insuredObjectsList[i].isCurrentVersion) ?? false)"></button>
                  </div>
                </div>

                <div class="insured-object__accordions-form-container" *ngIf="
                    objectFormArray.controls[i].get('predefinedAttribute')
                      ?.value?.length > 0
                  ">
                  <div class="insured-object__accordions-form-row__title">
                    Required Attribues
                  </div>
                  <div class="insured-object__accordions-form-multi-checkbox">
                    <cb-multi-checkbox [checkboxConfigs]="requiredAttributesList[getObjectId(i)]"
                      formControlName="requiredAttribute" groupAlignment="horizontal" [colorTheme]="colorTheme">
                    </cb-multi-checkbox>
                  </div>
                </div>
                <div class="insured-object__accordions-form-container" *ngIf="
                    objectFormArray.controls[i].get('predefinedAttribute')
                      ?.value?.length > 0
                  ">
                  <div class="insured-object__accordions-form-row__title">
                    Do Not Allow Duplicates
                  </div>
                  <div class="insured-object__accordions-form-multi-checkbox">
                    <cb-multi-checkbox [checkboxConfigs]="noDuplicatesList[getObjectId(i)]"
                      formControlName="doNotAllowDuplicateAttribute" groupAlignment="horizontal"
                      [colorTheme]="colorTheme"></cb-multi-checkbox>
                  </div>
                </div>

                <div formGroupName="allowedParties">
                  <div class="insured-object__accordions-form-row__title">
                    Allowed parties
                  </div>
                  <div class="insured-object__main-insured-wrapper">
                    <div class="insured-object__main-insured-select" [cbSelectMultiple]="selectAllowedParty"
                      [errorMessage]="
                        objectFormArray.controls[i]
                          .get('allowedParties')
                          ?.get('insured')?.invalid &&
                        (objectFormArray.controls[i]
                          .get('allowedParties')
                          ?.get('insured')?.dirty ||
                          objectFormArray.controls[i]
                            .get('allowedParties')
                            ?.get('insured')?.touched)
                          ? 'Required field'
                          : null
                      ">
                      <label class="insured-object__main-insured-label">Party type</label>
                      <p-multiSelect #selectAllowedParty [selectAll]="
                          selectAllFlags[getObjectId(i)]
                            ?.selectAllAllowedParties
                        " [options]="allowedPartiesList" optionLabel="description" placeholder="Define allowed parties"
                        inputId="#selectAllowedParty" formControlName="insured" (onChange)="
                          onMultiSelectChange(
                            $event,
                            insuredFormTypes.ALLOWEDPARTYTYPE,
                            objectFormArray.controls[i]
                          )
                        " (onSelectAllChange)="
                          onMultiSelectSelectAllChange(
                            $event,
                            insuredFormTypes.ALLOWEDPARTYTYPE,
                            objectFormArray.controls[i]
                          )
                        " [readOnly]="disableEdit"></p-multiSelect>
                    </div>
                    <div class="insured-object__main-insured-chips-container" *ngIf="
                        objectFormArray.controls[i]
                          .get('allowedParties')
                          ?.get('insured')?.value?.length > 0
                      ">
                      <p-chips fieldVariant="stroke" class="insured-object__main-insured-chips" field="description"
                        formControlName="insuredChipControl" [readOnly]="disableEdit" (onRemove)="
                          onChipRemove(
                            $event,
                            insuredFormTypes.ALLOWEDPARTYTYPE,
                            objectFormArray.controls[i]
                          )
                        "></p-chips>
                      <button cbButton label="Clear all selection" variant="primary" (click)="
                          clearSelection(
                            insuredFormTypes.ALLOWEDPARTYTYPE,
                            objectFormArray.controls[i]
                          )
                        " [disabled]="disableEdit || ((insuredObjectsList && insuredObjectsList[i] && !insuredObjectsList[i].isCurrentVersion) ?? false)"></button>
                    </div>
                  </div>

                  <div class="insured-object__accordions-form-row" *ngIf="policyHolderType?.value !== 'Entity'">
                    <div cbInput label="Minimum age" styleVariant="default" helpText="" [errorMessage]="
                        objectFormArray.controls[i]
                          .get('allowedParties')
                          ?.get('minAge')?.invalid &&
                        (objectFormArray.controls[i]
                          .get('allowedParties')
                          ?.get('minAge')?.dirty ||
                          objectFormArray.controls[i]
                            .get('allowedParties')
                            ?.get('minAge')?.touched)
                          ? 'Required field'
                          : null
                      ">
                      <input placeholder="Minimum age" type="number" pattern=".*" maxLength="3" formControlName="minAge"
                        [readOnly]="disableEdit" />
                    </div>

                    <div cbInput label="Maximum age" styleVariant="default" helpText="" [errorMessage]="
                        objectFormArray.controls[i]
                          .get('allowedParties')
                          ?.get('maxAge')?.invalid &&
                        (objectFormArray.controls[i]
                          .get('allowedParties')
                          ?.get('maxAge')?.dirty ||
                          objectFormArray.controls[i]
                            .get('allowedParties')
                            ?.get('maxAge')?.touched)
                          ? 'Required field'
                          : null
                      ">
                      <input placeholder="Maximum age" type="number" pattern=".*" maxLength="3" formControlName="maxAge"
                        [readOnly]="disableEdit" />
                    </div>
                  </div>
                </div>

                <div class="insured-object__custom-attributes-wrapper">
                  <div class="insured-object__tooltip" *ngIf="getAttributesFormArray(i).length > 0">
                    <div class="insured-object__custom-attributes-title">
                      Custom attributes
                    </div>
                    <div class="insured-object__tooltiptext">
                      <cb-tooltip
                        explanationText="Unique characteristics/attributes of the insured which further define the insured, product eligibility, & pricing."
                        styleVariant="stroke" [colorTheme]="cbToolTipColorTheme" direction="above-right">
                        <cb-icon iconKey="utility-tooltip-stroke"></cb-icon>
                      </cb-tooltip>
                    </div>
                  </div>
                  <div formGroupName="customAttributesForm">
                    <div formArrayName="attributes" class="insured-object__custom-attributes-form-array" *ngFor="
                        let attribute of getAttributesFormArray(i).controls;
                        let j = index
                      ">
                      <div [formGroupName]="j" class="insured-object__custom-attributes-form-group">
                        <div class="insured-object__custom-attributes-form-title-wrapper">
                          <div class="insured-object__custom-attributes-form-title">
                            {{ 'Attribute ' + (j + 1) }}
                          </div>
                          <cb-icon iconKey="utility-trash-fill" iconColor="error-saturated"
                            [iconSize]="cbIconSize.LARGE" [addPointerClass]="true" *ngIf="
                              getAttributesFormArray(i).length > 0 &&
                              !disableDel[i][j]
                            " (click)="enableDeleteConfirmation(i, j)"></cb-icon>
                        </div>
                        <div class="insured-object__custom-attributes-form-row">
                          <div cbCheckbox [colorTheme]="cbColorTheme.DEFAULT" label="Required">
                            <input type="checkbox" formControlName="required" [readOnly]="!disableEdit" />
                          </div>
                          <div cbCheckbox [colorTheme]="cbColorTheme.DEFAULT" label="Do not allow duplication">
                            <input type="checkbox" formControlName="allowDuplication" [readOnly]="!disableEdit" />
                          </div>
                        </div>
                        <div cbInput label="Attribute name" styleVariant="default"
                          [errorMessage]="_validateCustAttribute(i, j)">
                          <input placeholder="Attribute name" type="text" formControlName="name" maxLength="700"
                            [readOnly]="disableEdit" />
                        </div>
                        <div styleVariant="default" placeholder="Data type" class="cb-select-choice">
                          <div class="insured-object__tooltip">
                            <label class="cb-input__label">Data type</label>
                            <div class="insured-object__tooltiptextpa-data">
                              <cb-tooltip explanationText="Select the type of data" styleVariant="stroke"
                                [colorTheme]="cbToolTipColorTheme" direction="above-right">
                                <cb-icon iconKey="utility-tooltip-stroke"></cb-icon>
                              </cb-tooltip>
                            </div>
                          </div>

                          <select [disabled]="!disableEdit" name="options" id="options" formControlName="dataType"
                            (change)="onDataTypeChange(attribute)"
                            class="cb-select-choice__base-select cb-select-choice__custom-select">
                            <option *ngFor="let type of dataTypes" [value]="type.description">
                              {{ type.description }}
                            </option>
                          </select>
                        </div>

                        <div formArrayName="answers" *ngIf="attribute.get('dataType')?.value === 'DROPDOWN'">
                          <div class="insured-object__custom-attributes-title">DROPDOWN</div>
                          <div *ngFor="let answer of getAnswersControls(i, j).controls; let k = index"
                            [formGroupName]="k">
                            <div class="insured-object__custom-attributes-form-title-wrapper">
                              <div class="insured-object__custom-attributes-form-title">{{'Answer ' + (k + 1)}}</div>
                              <cb-icon class="insured-object__custom-attributes-form-group__delete"
                                iconKey="utility-trash-fill" iconColor="error-saturated" [iconSize]="cbIconSize.LARGE"
                                [addPointerClass]="true" (click)="removeAnswer(getAttribute(i, j), k)"
                                [ngClass]="{'disabled': disableEdit}"></cb-icon>
                            </div>
                            <div cbInput label="Answer value" styleVariant="default"
                              [errorMessage]="getDropdownAnswerErrorMessage(answer.get('answerValue'))">
                              <input formControlName="answerValue" placeholder="Answer Value" type="text" />
                            </div>
                            <div cbInput label="Answer description" styleVariant="default"
                              [errorMessage]="getDropdownAnswerErrorMessage(answer.get('answerDescription'))">
                              <input formControlName="answerDescription" placeholder="Answer Description" type="text" />
                            </div>
                          </div>
                          <button class="insured-object__custom-attributes-answer-title"
                            (click)="addAnswer(getAttribute(i, j))" [ngClass]="{'disabled': disableEdit}">+ Add
                            fields</button>
                        </div>

                        <div *ngIf="attribute.get('dataType')?.value === 'FILE'">
                          <div cbInput label="Maximum count" styleVariant="default"
                            [errorMessage]="attribute.get('maxOccurence')?.invalid && (attribute.get('maxOccurence')?.dirty || attribute.get('maxOccurence')?.touched) ? attribute.get('maxOccurence')?.errors?.['maxlength'] ? 'Data cannot be more than 100' : 'Required field' : null">
                            <input placeholder="Maximum count" type="number" pattern=".*" maxLength="2"
                              formControlName="maxOccurence" />
                          </div>
                          <div class="insured-type__main-insured-select" [cbSelectMultiple]="selectMultipleFiletype">
                            <label class="insured-type__main-insured-label">File type</label>
                            <p-multiSelect #selectMultipleFiletype [options]="fileTypeList" optionLabel="description"
                              placeholder="File types" formControlName="fileTypes" inputId="#selectMultipleFiletype"
                              (onSelectAllChange)="
                                onSelectAllFileTypes($event, attribute)
                              "></p-multiSelect>
                          </div>
                        </div>
                        <div cbInput
                          label="Default value"
                          styleVariant="default"
                          *ngIf="!(attribute.get('dataType')?.value === 'DROPDOWN' || attribute.get('dataType')?.value === 'FILE')">
                          <input
                              placeholder="Enter default value"
                              type="text"
                              formControlName="defaultValue"/>
                        </div>
                      </div>
                    </div>
                    <div class="insured-object__custom-attributes-form-action-button">
                      <button cbButton [label]="'Add custom attribute'" [leftIcon]="'utility-add'" variant="ghost"
                        [colorTheme]="colorTheme" (click)="addAttribute(i)" [disabled]="disableEdit"></button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>
          </p-accordionTab>
        </ng-container>
      </p-accordion>
    </div>

    <div class="insured-object__footer-buttons">
      <div class="insured-object__footer-buttons--left">
        <button cbButton label="Back" [leftIcon]="'utility-arrow-left'" variant="ghost" (click)="previous()"></button>
      </div>
      <div class="insured-object__footer-buttons--right">
        <button cbButton label="Save & exit" variant="secondary" [colorTheme]="colorTheme" (click)="saveAndExit()"
          [disabled]="disableEdit || currVersChange"></button>
        <button cbButton label="Save changes" variant="primary" [colorTheme]="colorTheme" (click)="saveAndNext()"
          *ngIf="!disableEdit || currVersChange"></button>
        <button cbButton label="Next" variant="primary" [colorTheme]="colorTheme" (click)="submit()"
          *ngIf="disableEdit"></button>
      </div>
    </div>
  </form>
</div>

<cb-modal [open]="openDeleteModal" (closeEvent)="handleDeleteModal()"
  title="Do you want to delete the custom attribute?" message="" [hideCloseIcon]="false">
  <div class="insured-object__modal-button-wrapper">
    <button cbButton label="Cancel" variant="secondary" (click)="handleDeleteModal()"></button>
    <button cbButton label="Yes" variant="primary" colorTheme="default" (click)="deleteConfirmation()"></button>
  </div>
</cb-modal>

<cb-modal [open]="openDeleteAttributeModal" (closeEvent)="handleDeleteAttributeModal()"
  title="Do you want to delete the custom attribute option?" message="" [hideCloseIcon]="false">
  <div class="insured-object__modal-button-wrapper">
    <button cbButton label="Cancel" variant="secondary" (click)="handleDeleteAttributeModal()"></button>
    <button cbButton label="Yes" variant="primary" colorTheme="default"
      (click)="deleteAttributeConfirmation()"></button>
  </div>
</cb-modal>
